"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CH=function(){function CH(a,b,textures){this.a=a,this.b=b,this.textures=textures,this.c=a}return CH.prototype.swap=function(){var tmp=this.a;this.a=this.b,this.b=tmp},CH}();exports.CH=CH;var RT=function(){function RT(gl,width,height){this.framebuffer=gl.createFramebuffer(),this.texture=gl.createTexture(),this.renderBuffer=gl.createRenderbuffer(),gl.bindTexture(3553,this.texture),gl.texImage2D(3553,0,6408,width,height,0,6408,5121,null),gl.texParameteri(3553,10242,33071),gl.texParameteri(3553,10243,33071),gl.texParameteri(3553,10240,9728),gl.texParameteri(3553,10241,9728),gl.bindFramebuffer(36160,this.framebuffer),gl.framebufferTexture2D(36160,36064,3553,this.texture,0),gl.bindRenderbuffer(36161,this.renderBuffer),gl.renderbufferStorage(36161,33189,width,height),gl.framebufferRenderbuffer(36160,36096,36161,this.renderBuffer),gl.bindTexture(3553,null),gl.bindRenderbuffer(36161,null),gl.bindFramebuffer(36160,null)}return RT}();exports.RT=RT;var DR=function(){function DR(canvas,v,f){this.canvas=canvas,this.header="#version 300 es\n        #ifdef GL_ES\n                precision highp float;\n                precision highp int;\n                precision mediump sampler3D;\n        #endif\n        ",this.channels=new Map,this.programs=new Map,this.textureCache=new Map,this.gl=canvas.getContext("webgl2",{preserveDrawingBuffer:!0});var gl=this.gl,c=0,d,info;for(var i in gl)"function"==typeof gl[i]&&(gl[d=(d=(255&c++).toString(16)).match(/^[0-9].*$/)?"x"+d:d]=gl[i]);if(gl.viewport(0,0,canvas.width,canvas.height),this.buffer=gl.createBuffer(),this.surfaceBuffer=gl.createBuffer(),this.mainProgram=gl.createProgram(),this.cS(this.mainProgram,35633,this.header+v),this.cS(this.mainProgram,35632,this.header+f),gl.linkProgram(this.mainProgram),this.gl.validateProgram(this.mainProgram),!gl.getProgramParameter(this.mainProgram,gl.LINK_STATUS))throw"Could not compile WebGL program. \n\n"+gl.getProgramInfoLog(this.mainProgram);gl.useProgram(this.mainProgram),this.screenVertexPosition=gl.getAttribLocation(this.mainProgram,"pos"),gl.enableVertexAttribArray(this.screenVertexPosition),gl.bindBuffer(34962,this.buffer),gl.bufferData(34962,new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),35044)}return DR.prototype.cS=function(program,type,source){var gl=this.gl,shader=gl.createShader(type);if(gl.shaderSource(shader,source),gl.compileShader(shader),gl.attachShader(program,shader),!this.gl.getShaderParameter(shader,35713))throw this.gl.getShaderInfoLog(shader).trim().split("\n").forEach((function(l){return console.error("[shader] "+l)})),new Error("Error while compiling vertex/fragment"+source)},DR.prototype.aP=function(name){var p=this.gl.createProgram();return this.programs.set(name,p),p},DR.prototype.t=function(image){var gl=this.gl,texture=gl.createTexture();return gl.bindTexture(3553,texture),gl.texImage2D(3553,0,6408,6408,5121,image),gl.generateMipmap(3553),texture},DR.prototype.aA=function(textures,cb){var _this=this,c=Object.keys(textures).length;return Object.keys(textures).forEach((function(key){var m=new Image;m.onload=function(e){_this.textureCache.set(key,_this.t(m)),_this.textureCache.size===c&&cb()},m.src=textures[key].src})),this},DR.prototype.aB=function(name,vertex,fragment,textures){var _this=this,gl=this.gl,channel=this.cC(this.canvas.width,this.canvas.height,textures||[]);this.channels.set(name,channel);var program=this.aP(name),info;if(this.cS(program,35633,this.header+vertex),this.cS(program,35632,this.header+fragment),gl.linkProgram(program),gl.validateProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw"Could not compile WebGL program. \n\n"+gl.getProgramInfoLog(program);return gl.useProgram(program),textures&&textures.forEach((function(tk){var m=_this.textureCache.get(tk);gl.bindTexture(3553,m)})),this.vertexPosition=gl.getAttribLocation(program,"pos"),gl.enableVertexAttribArray(this.vertexPosition),this},DR.prototype.R=function(time,customUniforms){var _this=this,gl=this.gl,main=this.mainProgram,i=0;this.programs.forEach((function(current,key){gl.useProgram(current);var channel=_this.channels.get(key);gl.uniform2f(gl.getUniformLocation(current,"resolution"),_this.canvas.width,_this.canvas.height),gl.uniform1f(gl.getUniformLocation(current,"time"),time),customUniforms&&Object.keys(customUniforms).forEach((function(v){customUniforms[v](gl.getUniformLocation(current,v),gl,current,time)})),channel.textures.forEach((function(tk){var loc=gl.getUniformLocation(current,tk);gl.activeTexture(33984+i),gl.uniform1i(loc,i),i++})),gl.bindBuffer(34962,_this.surfaceBuffer),gl.vertexAttribPointer(0,2,5126,!1,0,0),gl.bindBuffer(34962,_this.buffer),gl.vertexAttribPointer(0,2,5126,!1,0,0),gl.bindFramebuffer(36160,channel.a.framebuffer),gl.clear(16640),gl.drawArrays(4,0,6)})),gl.useProgram(main),gl.uniform2f(gl.getUniformLocation(main,"resolution"),this.canvas.width,this.canvas.height),gl.uniform1f(gl.getUniformLocation(main,"time"),time),gl.bindBuffer(34962,this.buffer),gl.vertexAttribPointer(0,2,5126,!1,0,0),this.channels.forEach((function(target,key){gl.uniform1i(gl.getUniformLocation(main,key),i),gl.activeTexture(33984+i),gl.bindTexture(3553,target.a.texture),i++,target.swap()})),gl.bindFramebuffer(36160,null),gl.clear(16640),gl.drawArrays(4,0,6)},DR.prototype.cC=function(width,height,textures){var gl=this.gl;return new CH(new RT(gl,width,height),new RT(gl,width,height),textures)},DR.prototype.run=function(t,customUniforms){var _this=this,fps=60,pt=performance.now(),interval=1e3/60,dt=0,a=function(t){requestAnimationFrame(a),(dt=t-pt)>1e3/60&&(pt=t-dt%(1e3/60),_this.R(pt/1e3,customUniforms))};return a(0|t),this},DR}();exports.DR=DR;