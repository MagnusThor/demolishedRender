"use strict";var DemolisedBuffers=function(){function DemolisedBuffers(canvas,v,f){this.canvas=canvas,this.header="#version 300 es\n        #ifdef GL_ES\n                precision highp float;\n                precision highp int;\n                precision mediump sampler3D;\n        #endif\n        ",this.targets=new Map,this.programs=new Map,this.textureCache=new Map,this.gl=canvas.getContext("webgl2",{preserveDrawingBuffer:!0}),this.gl.viewport(0,0,canvas.width,canvas.height);var gl=this.gl,info;if(this.buffer=gl.createBuffer(),this.surfaceBuffer=gl.createBuffer(),this.mainProgram=gl.createProgram(),this.createShader(this.mainProgram,this.gl.VERTEX_SHADER,this.header+v),this.createShader(this.mainProgram,this.gl.FRAGMENT_SHADER,this.header+f),this.gl.linkProgram(this.mainProgram),this.gl.validateProgram(this.mainProgram),!gl.getProgramParameter(this.mainProgram,gl.LINK_STATUS))throw"Could not compile WebGL program. \n\n"+gl.getProgramInfoLog(this.mainProgram);this.gl.useProgram(this.mainProgram),this.screenVertexPosition=gl.getAttribLocation(this.mainProgram,"pos"),gl.enableVertexAttribArray(this.screenVertexPosition),gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),gl.STATIC_DRAW)}return DemolisedBuffers.prototype.createShader=function(program,type,source){var shader=this.gl.createShader(type);if(this.gl.shaderSource(shader,source),this.gl.compileShader(shader),this.gl.attachShader(program,shader),!this.gl.getShaderParameter(shader,this.gl.COMPILE_STATUS))throw this.gl.getShaderInfoLog(shader).trim().split("\n").forEach((function(l){return console.error("[shader] "+l)})),new Error("Error while compiling vertex/fragment"+source)},DemolisedBuffers.prototype.addProgram=function(name){var p=this.gl.createProgram();return this.programs.set(name,p),p},DemolisedBuffers.prototype.ct=function(image){var gl=this.gl,texture=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),texture},DemolisedBuffers.prototype.addAssets=function(textures,cb){var _this=this,c=Object.keys(textures).length;Object.keys(textures).forEach((function(key){var m=new Image;m.onload=function(e){_this.textureCache.set(key,_this.ct(m)),_this.textureCache.size===c&&cb()},m.src=textures[key].src}))},DemolisedBuffers.prototype.addBuffer=function(name,vertex,fragment,textures){var _this=this,gl=this.gl,target=this.createTarget(this.canvas.width,this.canvas.height,textures||[]);this.targets.set(name,target);var program=this.addProgram(name),info;if(this.createShader(program,gl.VERTEX_SHADER,this.header+vertex),this.createShader(program,gl.FRAGMENT_SHADER,this.header+fragment),gl.linkProgram(program),gl.validateProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS))throw"Could not compile WebGL program. \n\n"+gl.getProgramInfoLog(program);return gl.useProgram(program),textures&&textures.forEach((function(tk){var m=_this.textureCache.get(tk);gl.bindTexture(3553,m)})),this.vertexPosition=gl.getAttribLocation(program,"pos"),gl.enableVertexAttribArray(this.vertexPosition),this},DemolisedBuffers.prototype.render=function(time){var _this=this,gl=this.gl,main=this.mainProgram,i=0;this.programs.forEach((function(current,key){gl.useProgram(current);var target=_this.targets.get(key);gl.uniform2f(gl.getUniformLocation(current,"resolution"),_this.canvas.width,_this.canvas.height),gl.uniform1f(gl.getUniformLocation(current,"time"),time),target.textures.forEach((function(tk){var loc=gl.getUniformLocation(current,tk);gl.activeTexture(gl.TEXTURE0+i),gl.uniform1i(loc,i),i++})),gl.bindBuffer(gl.ARRAY_BUFFER,_this.surfaceBuffer),gl.vertexAttribPointer(0,2,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,_this.buffer),gl.vertexAttribPointer(0,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,target.framebuffer),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.drawArrays(gl.TRIANGLES,0,6)})),gl.useProgram(main),gl.uniform2f(gl.getUniformLocation(main,"resolution"),this.canvas.width,this.canvas.height),gl.uniform1f(gl.getUniformLocation(main,"time"),time),gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),gl.vertexAttribPointer(0,2,gl.FLOAT,!1,0,0),this.targets.forEach((function(target,key){gl.uniform1i(gl.getUniformLocation(main,key),i),gl.activeTexture(gl.TEXTURE0+i),gl.bindTexture(gl.TEXTURE_2D,target.texture),i++})),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.drawArrays(gl.TRIANGLES,0,6)},DemolisedBuffers.prototype.createTarget=function(width,height,textures){var gl=this.gl,t={framebuffer:gl.createFramebuffer(),renderbuffer:gl.createRenderbuffer(),texture:gl.createTexture(),textures:textures};return gl.bindTexture(gl.TEXTURE_2D,t.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.bindFramebuffer(gl.FRAMEBUFFER,t.framebuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,t.texture,0),gl.bindRenderbuffer(gl.RENDERBUFFER,t.renderbuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,t.renderbuffer),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),t},DemolisedBuffers}(),player,vertex="layout(location = 0) in vec2 pos; \n        out vec4 fragColor;\n        void main() { \n            gl_Position = vec4(pos.xy,0.0,1.0);\n        }",fractal="uniform sampler2D iChannel0; uniform float time;uniform vec2 mouse,resolution;vec3 v=normalize(vec3(-1.,1,-.5));const float m=2e-05;float f=0.;float s(vec3 v){vec3 f=v;v=abs(1.-mod(v,2.));float r=0.,g=8.,c=1.;vec3 i=v;for(int m=0;m<7;m++){f=-1.+2.*fract(.5*f+.5);float t=dot(f,f);r=length(i);if(r>1.616)break;float n=acos(i.b/r),a=atan(i.g,i.r);c=pow(r,g-1.)*g*c+1.;float e=pow(r,g);n=n*g;a=a*g;i=e*vec3(sin(n)*cos(a),sin(a)*sin(n),cos(n));i+=v;}return.5*log(r)*r/c;}float t(vec3 v){float r=1.,i=0.;vec3 m=v,c=m;for(int f=0;f<6;f++)m=max(m=abs(mod(c*r+1.,2.)-1.),m.gbr),i=max(i,(.3-length(m*.95)*.3)/r),r*=2.;return i;}float n(vec3 v){return min(t(v),s(v));}vec3 x(in vec3 v){vec2 i=vec2(1.,-1.)*.5773*.0005;return normalize(i.rgg*n(v+i.rgg)+i.ggr*n(v+i.ggr)+i.grg*n(v+i.grg)+i.rrr*n(v+i.rrr));}float n(in vec3 v,in vec3 r){float i=0.,c=.05,m;for(int f=0;f<4;f++)m=n(v+r*c),i=min(6.*m/c,i),c+=m;return max(i,0.);}float s(const vec3 v,const vec3 r){float i=m*80.,f=0.,c=10.;for(int g=0;g<5;g++){float t=i+i*float(g*g);vec3 a=r*t+v;float s=n(a);f+=-(s-t)*c;c*=.75;}return clamp(1.-5.*f,0.,1.);}float e(vec3 v){v=abs(.5-fract(v*80.));float f,i=f=0.;for(int m=0;m<13;m++){float r=i;i=length(v);v=abs(v)/dot(v,v)-.5;f+=exp(-1./abs(i-r));}return f;}vec3 e(in vec3 i,in vec3 r){vec3 f=x(i);float m=min(5.,n(i,v)),c=s(i,f),g=max(0.,dot(v,-f))*m*1.3,a=max(.2,dot(r,-f))*.4;vec3 t=reflect(v,f);float w=pow(max(0.,dot(r,-t))*m,10.)*(.5+c*.5),d=e(i)*.18;vec3 p=mix(vec3(d*1.1,d*d*1.3,d*d*d),vec3(d),.45)*2.;p=p*c*(a*vec3(.9,.85,1.)+g*vec3(1.,.9,.9))+w*vec3(1,.9,.5)*.7;return p;}vec3 t(in vec3 v,in vec3 r){vec3 i,c;float g=0.,d=0.,a=0.;for(int t=0;t<128;t++){c=v+g*r;float p=.001*g;a=n(v+r*g);f=m*(1.+g*55.);if(a<.0002)break;g+=a;}vec3 t=vec3(.5);i=e(c-f*r*1.5,r);i*=vec3(1.,.85,.8)*.9;i=mix(i,t,1.-exp(-1.3*pow(g,1.3)));return i;}vec3 r(float v){vec2 i=600.*vec2(cos(1.4+.37*v),cos(3.2+.31*v));return vec3(i.r,0.,i.g);}float w(vec2 v){return fract(sin(dot(v,vec2(12.9898,78.233)))*33758.5)-.5;}vec3 r(vec3 v,vec2 r){return v=pow(v,vec3(.57)),v=mix(vec3(.5),mix(vec3(dot(vec3(.2125,.7154,.0721),v*1.2)),v*1.2,1.3),1.4),v;}out vec4 fragColor;float c[16];void main(){vec2 v=gl_FragCoord.rg/resolution.rg-.5;float i=time*.5;vec2 f=v*vec2(1.75,1.);vec3 m=r(i*.001),c=r(i+2.);float a=.4*cos(.4*i);vec3 g=normalize(c-m),d=vec3(sin(a),cos(a),0.),n=normalize(cross(g,d)),s=normalize(cross(n,g)),p=normalize(f.r*n+f.g*s+.6*g),e=t(m,p);e=r(e,f);vec4 oo = texture(iChannel0,vec2(0));fragColor=vec4(e,1.);}",kalispears="uniform float time;uniform vec2 mouse,resolution;uniform sampler2D iChannel0,iChannel1,iChannel2,iChannel3,iChannel4,fft;out vec4 fragColor;\n#define RAY_STEPS 100\n#define SHADOW_STEPS 50\n#define LIGHT_COLOR vec3(1.,.97,.93)\n#define AMBIENT_COLOR vec3(.75,.65,.6)\n#define SPECULAR 0.65\n#define DIFFUSE 1.0\n#define AMBIENT 0.35\n#define BRIGHTNESS 1.5\n#define GAMMA 1.35\n#define SATURATION.8\n#define detail.00004\n#define t time*.2\nvec3 lightdir=normalize(vec3(.1,-.15,-1.));const vec3 origin=vec3(-1.,.2,0.);float det=0.;vec3 pth1;mat2 rot(float v){return mat2(cos(v),sin(v),-sin(v),cos(v));}vec4 formula(vec4 v){return v.rb=abs(v.rb+1.)-abs(v.rb-1.)-v.rb,v=v*2./clamp(dot(v.rgb,v.rgb),.15,1.)-vec4(.5,.5,.8,0.),v.rg*=rot(.5),v;}float screen(vec3 v){float m=length(v.gb-vec2(.25,0.))-.5,i=length(v.gb-vec2(.25,2.))-.5;return min(max(m,abs(v.r-.3)-.01),max(i,abs(v.r+2.3)-.01));}vec2 de(vec3 v){float r=0.;vec3 m=v;m.b=abs(2.-mod(m.b,4.));vec4 i=vec4(m,1.5);float c=max(0.,.35-abs(v.g-3.35))/.35;\n#ifdef LESSDETAIL\nfor(int f=0;f<6;f++)i=formula(i);float f=max(-m.r-4.,(length(max(vec2(0.),i.gb-2.))-.5)/i.a);\n#else\nfor(int b=0;b<8;b++)i=formula(i);float d=max(-m.r-4.,length(max(vec2(0.),i.gb-3.))/i.a);\n#endif\nfloat b=screen(m),l=min(b,d);if(abs(l-b)<.001)r=1.;return vec2(l,r);}vec2 colorize(vec3 v){v.b=abs(2.-mod(v.b,4.));float m,i=m=0.,r=1000.;for(int f=0;f<15;f++){v=formula(vec4(v,0.)).rgb;float b=i;i=length(v);m+=exp(-10./abs(i-b));r=min(r,abs(i-3.));}return vec2(m,r);}vec3 path(float v){vec3 r=vec3(sin(v)*2.,(1.-sin(v*.5))*.5,-cos(v*.25)*30.)*.5;return r;}vec3 normal(vec3 v){vec3 m=vec3(0.,det,0.);return normalize(vec3(de(v+m.grr).r-de(v-m.grr).r,de(v+m.rgr).r-de(v-m.rgr).r,de(v+m.rrg).r-de(v-m.rrg).r));}float shadow(vec3 v,vec3 r){float m=1.,i=2.*det,f=10.;for(int b=0;b<SHADOW_STEPS;b++){if(i<1.&&f>detail){vec3 l=v-i*r;f=de(l).r;m=min(m,max(50.*f/i,0.));i+=max(.01,f);}}return clamp(m,.1,1.);}float calcAO(const vec3 v,const vec3 m){float r=detail*40.,f=0.,i=13.;for(int b=0;b<5;b++){float d=r*float(b*b);vec3 l=m*d+v;float c=de(l).r;f+=-(c-d)*i;i*=.7;}return clamp(1.-5.*f,0.,1.);}vec3 light(in vec3 v,in vec3 m,in vec3 r,in float i){float b=shadow(v,lightdir),f=calcAO(v,r),d=max(0.,dot(lightdir,-r))*b*DIFFUSE;vec3 l=max(.5,dot(m,-r))*AMBIENT*AMBIENT_COLOR,a=reflect(lightdir,r);float c=pow(max(0.,dot(m,-a))*b,15.)*SPECULAR;vec3 p;vec2 s=colorize(v);if(i>.5)p=vec3(1.),c=c*c;else{float g=pow(s.r*.11,2.);p=mix(vec3(g,g*g,g*g),vec3(g),.5)+.1;p+=pow(max(0.,1.-s.g),5.)*.3;}p=p*f*(l+d*LIGHT_COLOR)+c*LIGHT_COLOR;if(i>.5){vec3 n=v;n.b=abs(1.-mod(n.b,2.));vec3 g=texture(iChannel0,mod(1.-v.bg-vec2(.4,.2),vec2(1.))).rgb*2.;p+=g*abs(.01-mod(v.g-time*.1,.02))/.01*f;p*=max(0.,1.-pow(length(n.gb-vec2(.25,1.)),2.)*3.5);}else{vec3 g=texture(iChannel0,mod(v.br*2.+vec2(.5),vec2(1.))).rgb;g*=abs(.01-mod(v.r-time*.1*sign(v.r+1.),.02))/.01;p+=pow(s.r,10.)*3e-10*g;p+=pow(max(0.,1.-s.g),4.)*pow(max(0.,1.-abs(1.-mod(v.b+time*2.,4.))),2.)*vec3(1.,.8,.4)*4.*max(0.,.05-abs(v.r+1.))/.05;}return p;}vec3 raymarch(in vec3 v,in vec3 m){float r,i,b=r=0.;vec2 f=vec2(1.,0.);vec3 l,c=vec3(0.);for(int p=0;p<RAY_STEPS;p++){if(f.r>det&&b<30.){l=v+b*m;f=de(l);det=detail*(1.+b*50.);b+=f.r;if(f.r<.015)r+=max(0.,.015-f.r)*exp(-b);}}float g=max(0.,dot(normalize(-m),normalize(lightdir)));vec3 d=vec3(max(0.,-m.g+.6))*AMBIENT_COLOR*.5*max(.4,g);if(f.r<det||b<30.){l=l-abs(f.r-det)*m;vec3 p=normal(l);c=light(l,m,p,f.g);c=mix(c,d,1.-exp(-.15*pow(b,1.5)));}else{c=d;vec3 p=(m*3.+vec3(1.3,2.5,1.25))*.3;for(int n=0;n<13;n++)p=abs(p)/dot(p,p)-.9;c+=min(1.,pow(min(5.,length(p)),3.)*.0025);}vec3 p=LIGHT_COLOR*pow(g,25.)*.5;c+=r*(.5+g*.5)*LIGHT_COLOR*.7;c+=p*exp(min(30.,b)*.02);return c;}vec3 move(inout vec3 v){vec3 m=path(t),i=path(t+.7);float r=de(i).r;vec3 f=normalize(i-m);float b=i.r-m.r;b*=min(1.,abs(i.b-m.b))*sign(i.b-m.b)*.7;v.rg*=mat2(cos(b),sin(b),-sin(b),cos(b));b=f.g*1.7;v.gb*=mat2(cos(b),sin(b),-sin(b),cos(b));b=atan(f.r,f.b);v.rb*=mat2(cos(b),sin(b),-sin(b),cos(b));return m;}void main(){pth1=path(t+.3)+origin;vec2 v=gl_FragCoord.rg/resolution.rg*2.-1.;v.g*=resolution.g/resolution.r;vec3 b=normalize(vec3(v*.8,1.)),i=origin+move(b),m=raymarch(i,b);m=clamp(m,vec3(0.),vec3(1.));m=pow(m,vec3(GAMMA))*BRIGHTNESS;m=mix(vec3(length(m)),m,SATURATION);fragColor=vec4(m,1.);}\n",f="uniform float time;\nuniform vec2 resolution;\nuniform sampler2D iChannel0;\nout vec4 fragColor;\nvoid main(){\n        vec2 uv = gl_FragCoord.xy / resolution.xy*2.-1.;    \n        fragColor = texture(iChannel0,uv);                                             \n}",mainVertex="layout(location = 0) in vec2 pos; \n        out vec4 fragColor;                \n        void main() { \n            gl_Position = vec4(pos.xy,0.0,1.0);\n        }",mainFragment="uniform float time;\n        uniform vec2 resolution;\n        uniform sampler2D bufferA;\n        //uniform sampler2D bufferB;\n        out vec4 fragColor;\n        vec3 mod289(vec3 x) {\n                return x - floor(x * (1.0 / 289.0)) * 289.0;\n              }\n              \n              vec2 mod289(vec2 x) {\n                return x - floor(x * (1.0 / 289.0)) * 289.0;\n              }\n              \n              vec3 permute(vec3 x) {\n                return mod289(((x*34.0)+1.0)*x);\n              }\n              \n              float snoise(vec2 v)\n                {\n                const vec4 C = vec4(0.211324865405187, \n                                    0.366025403784439, \n                                   -0.577350269189626,  \n                                    0.024390243902439);\n                        vec2 i  = floor(v + dot(v, C.yy) );\n                vec2 x0 = v -   i + dot(i, C.xx);\n              \n                vec2 i1;\n                i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n                vec4 x12 = x0.xyxy + C.xxzz;\n                x12.xy -= i1;\n              \n                i = mod289(i);\n                vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n                              + i.x + vec3(0.0, i1.x, 1.0 ));\n              \n                vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n                m = m*m ;\n                m = m*m ;\n              \n                vec3 x = 2.0 * fract(p * C.www) - 1.0;\n                vec3 h = abs(x) - 0.5;\n                vec3 ox = floor(x + 0.5);\n                vec3 a0 = x - ox;\n              \n                m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n              \n                vec3 g;\n                g.x  = a0.x  * x0.x  + h.x  * x0.y;\n                g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n                return 130.0 * dot(m, g);\n              }\n              \n              float rand(vec2 co)\n              {\n                 return fract(sin(dot(co.xy,vec2(12.9898,78.233))) * 43758.5453);\n              }\n    \n               \n        void main(){                \n          vec2 uv = gl_FragCoord.xy / resolution.xy;\n          float noise = max(0.0, snoise(vec2(time, uv.y * 0.3)) - 0.3) * (1.0 / 0.7);\n          noise = noise + (snoise(vec2(time*10.0, uv.y * 2.4)) - 0.5) * 0.15;          \n          float xpos = uv.x - noise * noise * 0.25;\n              fragColor = texture(bufferA, vec2(xpos, uv.y));          \n          fragColor.rgb = mix(fragColor.rgb, vec3(rand(vec2(uv.y * time))), noise * 0.3).rgb;          \n          if (floor(mod(gl_FragCoord.y * 0.25, 2.0)) == 0.0)\n          {\n              fragColor.rgb *= 1.0 - (0.15 * noise);\n          }                                      \n        }";(player=new DemolisedBuffers(document.querySelector("#main"),mainVertex,mainFragment)).addAssets({iChannel0:{src:"assets/iChannel0.png"}},(function(){player.addBuffer("bufferA",vertex,kalispears,["iChannel0"]);var loop=function(t){player.render(t/1e3),st=(t-st)/requestAnimationFrame(loop)},st=0;setTimeout((function(){loop(0),console.log("started")}),2e3)}));