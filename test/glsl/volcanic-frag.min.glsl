uniform float time;uniform vec2 mouse,resolution;uniform sampler2D iChannel0,iChannel1,iChannel2;uniform int frame;uniform vec3 iMouse;out vec4 fragColor;
#define iTime time
#define iResolution resolution
#define HIGH_QUALITY_NOISE
float p(in vec3 i){vec3 v=floor(i),f=fract(i);f=f*f*(3.-2.*f);
#ifndef HIGH_QUALITY_NOISE
vec2 m=v.rg+vec2(37.,17.)*v.b+f.rg,g=textureLod(iChannel0,(m+.5)/256.,0.).gr;
#else
vec2 c=v.rg+vec2(37.,17.)*v.b,r=textureLod(iChannel0,(c+vec2(.5,.5))/256.,0.).gr,b=textureLod(iChannel0,(c+vec2(1.5,.5))/256.,0.).gr,d=textureLod(iChannel0,(c+vec2(.5,1.5))/256.,0.).gr,o=textureLod(iChannel0,(c+vec2(1.5,1.5))/256.,0.).gr,n=mix(mix(r,b,f.r),mix(d,o,f.r),f.g);
#endif
return mix(n.r,n.g,f.b);}float v(in vec2 i){vec2 v=floor(i),f=fract(i),c=v.rg+f.rg*f.rg*(3.-2.*f.rg);return textureLod(iChannel0,(c+118.4)/256.,0.).r;}vec4 p(sampler2D i,in vec3 v,in vec3 f){vec4 m=texture(i,v.gb),g=texture(i,v.br),b=texture(i,v.rg);return m*abs(f.r)+g*abs(f.g)+b*abs(f.b);}float f(vec2 i){i+=vec2(2.,4.);float f;f=.5*v(i);i=i*2.02;f+=.25*v(i);i=i*2.03;f+=.125*v(i);i=i*2.01;f+=.0625*v(i);return f;}const mat3 m=mat3(0.,.8,.6,-.8,.36,-.48,-.6,-.48,.64);float i(vec3 i){i+=vec3(1.,0.,.8);float f;f=.5*v(i);i=m*i*2.02;f+=.25*v(i);i=m*i*2.03;f+=.125*v(i);i=m*i*2.01;f+=.0625*v(i);float g=v(i*3.5);f+=.03*g*g;return f;}float t(in vec3 v){return v.g*.1+(i(v*vec3(.8,1.,.8))-.4)*(1.-smoothstep(1.,3.,v.g));}float f(in vec3 i,in vec3 v){float g=30.,f=.1;for(int m=0;m<256;m++){float c=t(i+v*f);if(c<.001*f||f>g)break;f+=c*.8;}if(f>g)f=-1.;return f;}vec3 i(in vec3 i,in float v){vec3 f=vec3(max(.02,.001*v),0.,0.);return normalize(vec3(t(i+f.rgg)-t(i-f.rgg),t(i+f.grg)-t(i-f.grg),t(i+f.ggr)-t(i-f.ggr)));}vec3 g=normalize(vec3(-.3,.4,.7));vec4 e(in vec3 i){vec3 m=i*.5+vec3(0.,-iTime,0.);float g;g=.5*v(m);m=m*2.02;g+=.25*v(m);m=m*2.03;g+=.125*v(m);m=m*2.01;g+=.0625*v(m);g=g-.55;g*=smoothstep(.5,.55,f(.1*i.rb)+.01);g=clamp(g,0.,1.);vec4 r=vec4(g);r.rgb=mix(vec3(1.,.8,.7),.2*vec3(.4,.4,.4),r.r);r.rgb*=.25;r.rgb*=.5+.5*smoothstep(-2.,1.,i.g);return r;}vec4 e(in vec3 v,in vec3 i,in vec3 f,float m){vec4 r=vec4(0.);float c=pow(clamp(dot(i,g),0.,1.),6.),b=0.;for(int t=0;t<60;t++){if(b>m||r.a>.95)break;vec3 d=v+b*i;vec4 n=e(d);n.rgb+=vec3(1.,.7,.4)*.4*c*(1.-n.a);n.rgb=mix(n.rgb,f,1.-exp(-6e-05*b*b*b));n.rgb*=n.a;r=r+n*(1.-r.a);b+=max(.1,.05*b);}r.rgb/=.001+r.a;return clamp(r,0.,1.);}float f(in vec3 i,in vec3 v,float m,float g){float f=1.,r=m;for(int c=0;c<64;c++){float b=t(i+v*r);b=max(b,0.);f=min(f,g*b/r);r+=clamp(b,.02,.5);if(f<.001)break;}return clamp(f,0.,1.);}vec3 x(float v){return vec3(16.*cos(.2+.05*v*1.5),1.5,16.*sin(.1+.055*v*1.5));}mat3 e(in vec3 i,in vec3 v,float f){vec3 g=normalize(v-i),b=vec3(sin(f),cos(f),0.),r=normalize(cross(g,b)),m=normalize(cross(r,g));return mat3(r,m,g);}void e(float i,out vec3 f,out vec3 v,out float r,out float g){vec3 m=x(i),n=x(i+1.6);n.g*=.35+.25*sin(.09*i);float t=.3*sin(1.+.07*i);f=m;v=n;r=t;g=2.1;}void e(out vec4 v,in vec2 m){vec2 b=m.rg/iResolution.rg,r=-1.+2.*b;r.r*=iResolution.r/iResolution.g;float c=step(.001,iMouse.b)*6.*iMouse.r/iResolution.r,t=3.4+iTime+c;vec3 n,o;float d,a;e(t,n,o,d,a);mat3 s=e(n,o,d);vec3 H=s*normalize(vec3(r.rg,a)),u=vec3(.32,.36,.4)-H.g*.4;float x=clamp(dot(H,g),0.,1.);u+=vec3(1.,.8,.4)*.2*pow(x,6.);u*=.9;vec3 l=u;float k=f(n,H),h=k;if(k>0.){vec3 C=n+k*H,z=i(C,k),R=-1.+2.*p(iChannel0,3.*C/4.,z).rgb;z=normalize(z+.6*R);float L=1.-smoothstep(-2.,1.,C.g),w=clamp(dot(z,g),0.,1.),I=0.;if(w>.01)I=f(C,g,.01,32.);float T=clamp(dot(z,normalize(g*vec3(-1.,0.,-1.))),0.,1.),M=.5+.5*z.g,Y=smoothstep(.5,.55,f(.1*C.rb))*L*clamp(.5-.5*z.g,0.,1.),U=pow((1.-i(C*vec3(.8,1.,.8)))*1.6-.5,2.),S=1.;u=vec3(.8);vec3 Q=vec3(0.);Q+=1.4*w*vec3(1.8,1.27,.99)*pow(vec3(I),vec3(1.,1.2,1.5));Q+=.9*M*vec3(.16,.2,.4)*U;Q+=.9*T*vec3(.4,.28,.2)*U;Q+=.9*S*vec3(.15,.17,.2)*U;Q+=Y*vec3(3.,.61,0.);u=p(iChannel1,.5*C,z).rgb;u=u*(.2+.8*p(iChannel2,4.*vec3(2.,8.,2.)*C,z).r);vec3 O=vec3(1.,.9,.2);O*=texture(iChannel2,C.rb).rgb;u=mix(u,.8*O,L);float N=smoothstep(0.,.8,z.g)*smoothstep(0.,.1,C.g-.8);O=vec3(.2,.45,.1);O*=texture(iChannel2,30.*C.rb).rgb;O+=.2*texture(iChannel2,C.rb).rgb;N*=smoothstep(0.,.5,texture(iChannel2,.1*C.rb+.01*z.r).r);u=mix(u,O*1.1,N);u=Q*u;vec3 G=normalize(g-H);u+=vec3(1.8,1.27,.99)*pow(clamp(dot(z,G),0.,1.),16.)*w*I*(.04+.96*pow(clamp(1.+dot(G,H),0.,1.),5.));u=mix(u,(1.-.7*L)*l,1.-exp(-6e-05*k*k*k));}u+=vec3(1.,.6,.2)*.2*pow(x,2.)*clamp((H.g+.4)/.4,0.,1.);{if(k<0.)k=600.;vec4 C=e(n,H,l,k);u=mix(u,C.rgb,C.a);}u=pow(clamp(u,0.,1.),vec3(.45));u=u*.3+.7*u*u*(3.-2.*u);u=mix(u,vec3(u.r+u.g+u.b)*.33,.2);u*=1.25*vec3(1.02,1.05,1.);float z=-1.;if(h>0.){float C=t-1./30.;vec3 G,U;float L,O;e(C,G,U,L,O);mat3 I=e(G,U,L);vec3 w=n+H*h,R=vec3(dot(w-G,I[0]),dot(w-G,I[1]),dot(w-G,I[2]));vec2 T=O*R.rg/R.b,Q=.5+.5*T*vec2(iResolution.g/iResolution.r,1.),N=m/iResolution.rg;Q=clamp(.5+.5*(Q-N)/.25,0.,1.);z=floor(Q.r*255.)+floor(Q.g*255.)*256.;}v=vec4(u,z);}void main(){e(fragColor,gl_FragCoord.rg);}
